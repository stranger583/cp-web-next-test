name: "Notify Google Chat"
description: "Send notification to Google Chat with standardized format"
inputs:
  name:
    description: "Notification name"
    required: true
  url:
    description: "Google Chat webhook URL"
    required: true
  type:
    description: "Notification type (success, error, tag_success)"
    required: true
  branch_type:
    description: "Branch type (beta, delta)"
    required: true
  branch_name:
    description: "Branch name"
    required: true
  merged_count:
    description: "Number of merged tasks"
    required: false
    default: "0"
  total_tasks:
    description: "Total number of tasks"
    required: false
    default: "0"
  failed_tasks:
    description: "Failed tasks list"
    required: false
    default: ""
  failed_branches:
    description: "Failed branches list"
    required: false
    default: ""
  tag_moved:
    description: "Whether tag was moved"
    required: false
    default: "No"
  failed_assignees:
    description: "Failed tasks assignees to mention"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Send Google Chat Notification
      shell: bash
      run: |
        # æº–å‚™è¨Šæ¯å…§å®¹ (æ¸¬è©¦å¿«å–æ˜¯å¦å­˜åœ¨)
        if [ "${{ inputs.type }}" = "success" ]; then
          EMOJI="ğŸŸ¢"
          TITLE="${{ inputs.branch_type == 'beta' && 'Beta' || 'Delta' }} Merge Success"
          ADDITIONAL_INFO="ğŸ“ *Repository:* \`${GITHUB_REPOSITORY}\`
        - *Branch:* \`${{ inputs.branch_name }}\`
        - *Total ${{ inputs.branch_type }} tasks:* ${{ inputs.total_tasks }}
        - *Successfully merged:* ${{ inputs.merged_count }}
        - *Failed:* ${{ inputs.failed_count }}
        - *Tag Moved:* ${{ inputs.tag_moved }}"
        elif [ "${{ inputs.type }}" = "error" ]; then
          EMOJI="ğŸ”´"
          TITLE="${{ inputs.branch_type == 'beta' && 'Beta' || 'Delta' }} Tasks Processing Failed"
          
          # Build failed information
          FAILED_INFO="ğŸ“ *Repository:* \`${GITHUB_REPOSITORY}\`
        - *Branch:* \`${{ inputs.branch_name }}\`
        - *Total ${{ inputs.branch_type }} tasks:* ${{ inputs.total_tasks }}
        - *Successfully merged:* ${{ inputs.merged_count }}
        - *Failed:* ${{ inputs.failed_count }}"
          
          # Add failed tasks if available
          if [ -n "${{ inputs.failed_tasks }}" ]; then
            FAILED_INFO="${FAILED_INFO}
        âŒ *Failed Tasks:*"
            # Split failed tasks and format as list
            IFS='|' read -ra tasks <<< "${{ inputs.failed_tasks }}"
            for task in "${tasks[@]}"; do
              FAILED_INFO="${FAILED_INFO}
        - ${task}"
            done
          fi
          
          # Add assignee mentions if available
          if [ -n "${{ inputs.failed_assignees }}" ]; then
            FAILED_INFO="${FAILED_INFO}

        ğŸ‘¥ *Please check:* ${{ inputs.failed_assignees }}"
          fi
          
          ADDITIONAL_INFO="$FAILED_INFO"
        else
          EMOJI="ğŸŸ¢"
          TITLE="${{ inputs.branch_type == 'beta' && 'Beta' || 'Delta' }} Move Tag Success"
          ADDITIONAL_INFO="ğŸ“ *Repository:* \`${GITHUB_REPOSITORY}\`
        ğŸŒ¿ *Branch:* \`${{ inputs.branch_name }}\`
        ğŸ·ï¸ *Tag:* \`${{ inputs.branch_type }}\`
        ğŸ“Š *Total ${{ inputs.branch_type }} tasks:* ${{ inputs.total_tasks }}
        âœ… *Successfully merged:* ${{ inputs.merged_count }}
        âŒ *Failed:* ${{ inputs.failed_count }}"
        fi

        # æ§‹å»ºå®Œæ•´è¨Šæ¯
        MESSAGE="${EMOJI} *${TITLE}*

        ${ADDITIONAL_INFO}"

        # ç™¼é€åˆ° Google Chat
        curl -X POST \
          -H 'Content-Type: application/json' \
          -d "{\"text\": \"${MESSAGE}\"}" \
          "${{ inputs.url }}"
