name: "Move Tag"
description: "Move tag if merge was successful"
inputs:
  merged_count:
    description: "Number of successfully merged tasks"
    required: true
  failed_count:
    description: "Number of failed tasks"
    required: true
  tag_name:
    description: "Tag name to move"
    required: true
  branch_name:
    description: "Branch name"
    required: true
  step_name:
    description: "Step name for logging"
    required: true
  pat_token: # ðŸ’¡ æ–°å¢žé€™å€‹ input
    description: "Personal Access Token for push"
    required: true
outputs:
  tag_moved:
    description: "Whether tag was moved"
    value: ${{ steps.move.outputs.tag_moved }}

runs:
  using: "composite"
  steps:
    - name: Move Tag
      id: move
      shell: bash
      run: |
        if [ ${{ inputs.failed_count }} -gt 0 ]; then
          echo "âš ï¸ Skipping ${{ inputs.tag_name }} tag movement (errors: ${{ inputs.failed_count }}, merged: ${{ inputs.merged_count }})"
          echo "tag_moved=false" >> $GITHUB_OUTPUT
        elif [ ${{ inputs.merged_count }} -gt 0 ]; then
          echo "ðŸ·ï¸ Moving ${{ inputs.tag_name }} tag to current commit..."
          # è¨­å®š PAT ä¾†æŽ¨é€
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git remote set-url origin https://${{ inputs.pat_token }}@github.com/${{ github.repository }}.git
          
          # ç›´æŽ¥åŸ·è¡Œ tag æ“ä½œï¼Œä¸ä½¿ç”¨ yarn
          TAG_NAME="${{ inputs.tag_name }}"
          echo "ðŸ—‘ï¸ Deleting local tag: $TAG_NAME"
          git tag -d "${TAG_NAME}" || true
          echo "ðŸ—‘ï¸ Deleting remote tag: $TAG_NAME"
          git push --delete origin "${TAG_NAME}" || true
          echo "ðŸ·ï¸ Creating new tag: $TAG_NAME"
          git tag -a "${TAG_NAME}" -m "${TAG_NAME}"
          echo "ðŸ“¤ Pushing new tag: $TAG_NAME"
          git push origin "${TAG_NAME}"
          
          if [ $? -eq 0 ]; then
            echo "âœ… Successfully moved ${{ inputs.tag_name }} tag"
            echo "tag_moved=true" >> $GITHUB_OUTPUT
            echo "ðŸ” Debug: Set tag_moved=true" >&2
            
            {
              echo "### ðŸ·ï¸ ${{ inputs.step_name }} Tag Movement"
              echo "- **Tag:** \`${{ inputs.tag_name }}\`"
              echo "- **Status:** âœ… Successfully moved to current commit"
              echo "- **Branch:** \`${{ inputs.branch_name }}\`"
            } >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to move ${{ inputs.tag_name }} tag"
            echo "tag_moved=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âš ï¸ Skipping ${{ inputs.tag_name }} tag movement (no merges)"
          echo "tag_moved=false" >> $GITHUB_OUTPUT
        fi
